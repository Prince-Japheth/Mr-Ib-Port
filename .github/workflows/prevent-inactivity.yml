name: Prevent Supabase Inactivity

on:
  schedule:
    # Run at 9:00 UTC every Monday and Thursday
    - cron: '0 9 * * 1,4'
  workflow_dispatch:

jobs:
  ping-supabase:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install Supabase Client
        run: pnpm add @supabase/supabase-js
        
      - name: Ping Supabase
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_KEY;
          
          if (!supabaseUrl || !supabaseKey) {
            console.error('Missing Supabase credentials');
            process.exit(1);
          }
          
          const supabase = createClient(supabaseUrl, supabaseKey);
          
          async function ping() {
            console.log('Pinging Supabase...');
            // Query a system table or a known table to generate traffic
            // Using a simple query that should always work if the DB is up
            const { data, error } = await supabase
              .from('user_roles') // Using a table that likely exists, or we can use a raw query if preferred, but client usually needs a table for .from()
              .select('id')
              .limit(1);
              
            // Alternative: if user_roles doesn't exist, we might want to try a different approach.
            // However, usually 'auth.users' is not directly accessible via client without service role, 
            // but we are using service role key here.
            
            // Let's try a safer generic query if possible, or just assume a table exists.
            // Since I don't know the exact schema, I'll use a raw query which is safer if enabled, 
            // but supabase-js rpc is better if a function exists.
            // Fallback: Just use a simple select from a table that definitely exists or handle error gracefully.
            // Actually, even a failed query counts as traffic.
            
            if (error) {
              console.error('Error pinging Supabase:', error);
              // Even if there is an error (e.g. table not found), the connection attempt might count as activity.
              // But to be safe, let's try to list buckets which is a storage operation, or just auth.
              
              // Let's try to get the user session (won't work without a token) or just list users (needs admin rights).
              // With service role key, we can list users.
              const { data: users, error: userError } = await supabase.auth.admin.listUsers({ page: 1, perPage: 1 });
              
              if (userError) {
                 console.error('Error listing users:', userError);
                 process.exit(1);
              }
              console.log('Ping successful (via auth.admin.listUsers)');
            } else {
              console.log('Ping successful!');
            }
          }
          
          ping().catch(err => {
            console.error('Script failed:', err);
            process.exit(1);
          });
          "
